syntax = "proto3";

package iterm_mcp;

service ITermService {
  // Session operations
  rpc ListSessions (Empty) returns (SessionList);
  rpc FocusSession (SessionIdentifier) returns (StatusResponse);
  rpc CheckSessionStatus (SessionIdentifier) returns (SessionStatus);
  rpc SetActiveSession (SetActiveSessionRequest) returns (StatusResponse);

  // Create sessions with layout
  rpc CreateSessions (CreateSessionsRequest) returns (CreateSessionsResponse);

  // Write/Read with array-based parallel support
  rpc WriteToSessions (WriteToSessionsRequest) returns (WriteToSessionsResponse);
  rpc ReadSessions (ReadSessionsRequest) returns (ReadSessionsResponse);

  // Control characters
  rpc SendControlCharacter (ControlCharRequest) returns (StatusResponse);

  // Agent management
  rpc RegisterAgent (RegisterAgentRequest) returns (Agent);
  rpc ListAgents (ListAgentsRequest) returns (AgentList);
  rpc RemoveAgent (AgentIdentifier) returns (StatusResponse);

  // Team management
  rpc CreateTeam (CreateTeamRequest) returns (Team);
  rpc ListTeams (Empty) returns (TeamList);
  rpc RemoveTeam (TeamIdentifier) returns (StatusResponse);
  rpc AssignAgentToTeam (AgentTeamAssignment) returns (StatusResponse);
  rpc RemoveAgentFromTeam (AgentTeamAssignment) returns (StatusResponse);

  // Cascading messages
  rpc SendCascadeMessage (CascadeMessageRequest) returns (CascadeMessageResponse);
}

// ==================== Basic Messages ====================

message Empty {}

message StatusResponse {
  string message = 1;
  bool success = 2;
}

// ==================== Session Messages ====================

message Session {
  string id = 1;
  string name = 2;
  string persistent_id = 3;
  bool is_processing = 4;
  string agent = 5;  // Agent name if registered
}

message SessionList {
  repeated Session sessions = 1;
}

message SessionIdentifier {
  string identifier = 1;  // Can be session_id, name, or agent name
}

message SessionStatus {
  string name = 1;
  string id = 2;
  string persistent_id = 3;
  bool is_processing = 4;
  string agent = 5;
}

message SetActiveSessionRequest {
  oneof target {
    string session_id = 1;
    string name = 2;
    string agent = 3;
  }
}

// ==================== Session Target ====================

message SessionTarget {
  string session_id = 1;
  string name = 2;
  string agent = 3;
  string team = 4;  // Targets all team members
}

// ==================== Create Sessions ====================

message SessionConfig {
  string name = 1;
  string agent = 2;
  string team = 3;
  string command = 4;
  int32 max_lines = 5;
  bool monitor = 6;
}

message CreateSessionsRequest {
  repeated SessionConfig sessions = 1;
  string layout = 2;  // SINGLE, HORIZONTAL_SPLIT, VERTICAL_SPLIT, QUAD, etc.
  string window_id = 3;  // Optional: create in existing window
}

message CreatedSession {
  string session_id = 1;
  string name = 2;
  string agent = 3;
  string persistent_id = 4;
}

message CreateSessionsResponse {
  repeated CreatedSession sessions = 1;
  string window_id = 2;
}

// ==================== Write to Sessions ====================

message SessionMessage {
  string content = 1;
  repeated SessionTarget targets = 2;  // Empty = active session
  string condition = 3;  // Regex pattern - only send if matches
  bool execute = 4;  // Press Enter after sending
  string use_encoding = 5;  // "auto", "true", "false"
}

message WriteToSessionsRequest {
  repeated SessionMessage messages = 1;
  bool parallel = 2;  // Execute in parallel
  bool skip_duplicates = 3;  // Skip duplicate messages
}

message WriteResult {
  string session_id = 1;
  string session_name = 2;
  bool success = 3;
  string error = 4;
  bool skipped = 5;
  string skipped_reason = 6;
}

message WriteToSessionsResponse {
  repeated WriteResult results = 1;
  int32 sent_count = 2;
  int32 skipped_count = 3;
  int32 error_count = 4;
}

// ==================== Read Sessions ====================

message ReadTarget {
  string session_id = 1;
  string name = 2;
  string agent = 3;
  string team = 4;
  int32 max_lines = 5;
}

message ReadSessionsRequest {
  repeated ReadTarget targets = 1;  // Empty = active session
  bool parallel = 2;
  string filter_pattern = 3;  // Regex pattern to filter output
}

message SessionOutput {
  string session_id = 1;
  string name = 2;
  string agent = 3;
  string content = 4;
  int32 line_count = 5;
  bool truncated = 6;
}

message ReadSessionsResponse {
  repeated SessionOutput outputs = 1;
  int32 total_sessions = 2;
}

// ==================== Control Characters ====================

message ControlCharRequest {
  SessionTarget target = 1;
  string control_char = 2;
}

// ==================== Agent Management ====================

message Agent {
  string name = 1;
  string session_id = 2;
  repeated string teams = 3;
  string created_at = 4;
  map<string, string> metadata = 5;
}

message AgentList {
  repeated Agent agents = 1;
}

message AgentIdentifier {
  string name = 1;
}

message RegisterAgentRequest {
  string name = 1;
  string session_id = 2;
  repeated string teams = 3;
  map<string, string> metadata = 4;
}

message ListAgentsRequest {
  string team = 1;  // Optional: filter by team
}

// ==================== Team Management ====================

message Team {
  string name = 1;
  string description = 2;
  string parent_team = 3;
  string created_at = 4;
  int32 member_count = 5;
}

message TeamList {
  repeated Team teams = 1;
}

message TeamIdentifier {
  string name = 1;
}

message CreateTeamRequest {
  string name = 1;
  string description = 2;
  string parent_team = 3;
}

message AgentTeamAssignment {
  string agent_name = 1;
  string team_name = 2;
}

// ==================== Cascade Messages ====================

message CascadeMessageRequest {
  string broadcast = 1;  // Message to ALL agents
  map<string, string> teams = 2;  // Team-specific messages
  map<string, string> agents = 3;  // Agent-specific messages
  bool skip_duplicates = 4;
  bool execute = 5;
}

message CascadeResult {
  string agent = 1;
  string session_id = 2;
  string message_type = 3;  // "broadcast", "team", "agent"
  bool delivered = 4;
  string skipped_reason = 5;
}

message CascadeMessageResponse {
  repeated CascadeResult results = 1;
  int32 delivered_count = 2;
  int32 skipped_count = 3;
}
