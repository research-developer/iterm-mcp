#!/usr/bin/env bash
#
# iterm-mcp-daemon - Manage the iTerm MCP singleton daemon
#
# Usage:
#   iterm-mcp-daemon start    # Start the daemon
#   iterm-mcp-daemon stop     # Stop the daemon
#   iterm-mcp-daemon restart  # Restart the daemon
#   iterm-mcp-daemon status   # Check if daemon is running
#   iterm-mcp-daemon logs     # Tail the daemon logs

set -e

# Configuration
DAEMON_NAME="iterm-mcp"
DAEMON_PORT="${ITERM_MCP_PORT:-12345}"
DAEMON_HOST="${ITERM_MCP_HOST:-127.0.0.1}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON="${ITERM_MCP_PYTHON:-/Users/preston/miniconda3/envs/mcp/bin/python}"
LOG_DIR="${HOME}/.iterm-mcp"
LOG_FILE="${LOG_DIR}/daemon.log"
PID_FILE="${LOG_DIR}/daemon.pid"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

get_pid() {
    if [[ -f "${PID_FILE}" ]]; then
        cat "${PID_FILE}"
    else
        echo ""
    fi
}

is_running() {
    local pid=$(get_pid)
    if [[ -n "${pid}" ]] && kill -0 "${pid}" 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

start_daemon() {
    if is_running; then
        log_warn "Daemon already running (PID: $(get_pid))"
        return 0
    fi

    log_info "Starting ${DAEMON_NAME} daemon on ${DAEMON_HOST}:${DAEMON_PORT}..."

    # Start the server in background
    nohup "${PYTHON}" "${SCRIPT_DIR}/run_server.py" \
        --transport streamable-http \
        --host "${DAEMON_HOST}" \
        --port "${DAEMON_PORT}" \
        >> "${LOG_FILE}" 2>&1 &

    local pid=$!
    echo "${pid}" > "${PID_FILE}"

    # Wait a moment and check if it started successfully
    sleep 2

    if is_running; then
        log_info "Daemon started (PID: ${pid})"
        log_info "Endpoint: http://${DAEMON_HOST}:${DAEMON_PORT}/mcp"
        log_info "Logs: ${LOG_FILE}"
    else
        log_error "Daemon failed to start. Check logs: ${LOG_FILE}"
        rm -f "${PID_FILE}"
        return 1
    fi
}

stop_daemon() {
    if ! is_running; then
        log_warn "Daemon not running"
        rm -f "${PID_FILE}"
        return 0
    fi

    local pid=$(get_pid)
    log_info "Stopping ${DAEMON_NAME} daemon (PID: ${pid})..."

    kill "${pid}" 2>/dev/null || true

    # Wait for graceful shutdown
    local count=0
    while is_running && [[ $count -lt 10 ]]; do
        sleep 1
        ((count++))
    done

    if is_running; then
        log_warn "Daemon didn't stop gracefully, forcing..."
        kill -9 "${pid}" 2>/dev/null || true
    fi

    rm -f "${PID_FILE}"
    log_info "Daemon stopped"
}

status_daemon() {
    if is_running; then
        local pid=$(get_pid)
        log_info "Daemon running (PID: ${pid})"
        log_info "Endpoint: http://${DAEMON_HOST}:${DAEMON_PORT}/mcp"

        # Check if it's responding
        if curl -s -o /dev/null -w "%{http_code}" "http://${DAEMON_HOST}:${DAEMON_PORT}/mcp" | grep -q "200\|405"; then
            log_info "Health: responding"
        else
            log_warn "Health: not responding (may still be starting)"
        fi
    else
        log_info "Daemon not running"
        return 1
    fi
}

show_logs() {
    if [[ -f "${LOG_FILE}" ]]; then
        tail -f "${LOG_FILE}"
    else
        log_error "No log file found: ${LOG_FILE}"
        return 1
    fi
}

show_usage() {
    echo "Usage: $(basename "$0") {start|stop|restart|status|logs}"
    echo ""
    echo "Commands:"
    echo "  start    Start the iTerm MCP daemon"
    echo "  stop     Stop the iTerm MCP daemon"
    echo "  restart  Restart the iTerm MCP daemon"
    echo "  status   Check daemon status"
    echo "  logs     Tail daemon logs"
    echo ""
    echo "Environment variables:"
    echo "  ITERM_MCP_PORT   - Port to listen on (default: 12345)"
    echo "  ITERM_MCP_HOST   - Host to bind to (default: 127.0.0.1)"
    echo "  ITERM_MCP_PYTHON - Python interpreter path"
}

# Main
case "${1:-}" in
    start)
        start_daemon
        ;;
    stop)
        stop_daemon
        ;;
    restart)
        stop_daemon
        sleep 1
        start_daemon
        ;;
    status)
        status_daemon
        ;;
    logs)
        show_logs
        ;;
    *)
        show_usage
        exit 1
        ;;
esac
